---
priority: domain
applies_to: when working with operations
conflicts_with: none
examples: see Examples section below
---

# Electric Sheep Toolset Operations

This file defines all available operations in the toolset. Operations are identified by code names and can be queried by AI agents.

## Query Operations

To discover available operations, agents can:
1. Query `.toolset/operations.json` for structured operation data
2. Use the discovery script: `python .toolset/discover_operations.py`
3. Check this ruleset file for descriptions

## Operation Categories

### System Operations

#### `bambu-lab:launch`
**Code Name**: `bambu-lab:launch`
**Description**: Launch Bambu Lab with automatic CPU affinity fix
**Tool**: `tools/system/bambu-lab`
**Parameters**: Optional path, optional core list
**Privacy**: No sensitive data

#### `bambu-lab:set-affinity`
**Code Name**: `bambu-lab:set-affinity`
**Description**: Set CPU affinity for running Bambu Lab process
**Tool**: `tools/system/bambu-lab`
**Parameters**: Optional core list, wait flag
**Privacy**: No sensitive data

#### `bambu-lab:find-installation`
**Code Name**: `bambu-lab:find-installation`
**Description**: Find Bambu Studio installation path
**Tool**: `tools/system/bambu-lab`
**Parameters**: None
**Privacy**: No sensitive data (searches common locations)

#### `cpu-affinity:check`
**Code Name**: `cpu-affinity:check`
**Description**: Check CPU affinity for processes
**Tool**: `tools/system/cpu-affinity`
**Parameters**: Optional process name/ID
**Privacy**: No sensitive data

### AI Operations

#### `musubi-tuner:activate-env`
**Code Name**: `musubi-tuner:activate-env`
**Description**: Activate Musubi Tuner virtual environment
**Tool**: `tools/ai/musubi-tuner`
**Parameters**: None (uses local config)
**Privacy**: Path stored in local config (not in repo)

#### `musubi-tuner:wan:prepare-dataset`
**Code Name**: `musubi-tuner:wan:prepare-dataset`
**Description**: Prepare training dataset by copying images recursively from source (including subfolders), generating captions, and ensuring trigger words are included
**Tool**: `tools/ai/musubi-tuner`
**Parameters**: Source image directory, target directory, Qwen model path, trigger word
**Privacy**: Paths stored in local config or provided as parameters
**Scripts**: 
  - `tools/ai/musubi-tuner/scripts/prepare-dani-dataset.ps1` (recursive, recommended)
  - `tools/ai/musubi-tuner/scripts/prepare-angelina-dataset-new.ps1` (flat directory only)
**Command Pattern**: When user says "prepare dataset for <path>":
  1. Extract dataset name from path (last folder name, e.g., `dani` from `E:\Stable Diffusion\Inputs\df\lib\female\dani`)
  2. Set target directory to `E:\Stable Diffusion\TrainingDataSet\<dataset_name>`
  3. Use recursive search (include subfolders)
  4. Extract trigger word from dataset name (lowercase, e.g., `dani`)
  5. Run `prepare-dani-dataset.ps1` script with appropriate parameters
**Default Behavior**:
  - Source: Path provided by user
  - Target: `E:\Stable Diffusion\TrainingDataSet\<dataset_name>`
  - Trigger Word: Extracted from dataset name (lowercase)
  - Qwen Model: `Qwen/Qwen2.5-VL-7B-Instruct` (default HuggingFace model)
  - Recursive: Always enabled (searches subfolders)
**Critical Implementation Note - Special Characters in Filenames**:
  - When reading/writing caption files, MUST use `.NET` methods: `[System.IO.File]::ReadAllText()` and `[System.IO.File]::WriteAllText()`
  - MUST use `Test-Path -LiteralPath` instead of `Test-Path` for files with special characters (brackets, spaces, etc.)
  - PowerShell's `Get-Content` cmdlet fails silently on files with brackets like `[image] - 123.jpg`
  - Always wrap file operations in try-catch blocks for error handling
  - Example: Files named `[image] - 3858010.jpg` will have caption files `[image] - 3858010.txt` that require special handling

#### `musubi-tuner:wan:cache-latents`
**Code Name**: `musubi-tuner:wan:cache-latents`
**Description**: Cache VAE latents for Wan 2.1/2.2 training
**Tool**: `tools/ai/musubi-tuner`
**Parameters**: Dataset config, VAE path, T5 path, optional CLIP path
**Privacy**: Paths stored in local config

#### `musubi-tuner:wan:cache-text-encoder`
**Code Name**: `musubi-tuner:wan:cache-text-encoder`
**Description**: Cache text encoder outputs for training
**Tool**: `tools/ai/musubi-tuner`
**Parameters**: Dataset config, T5 path, batch size
**Privacy**: Paths stored in local config

#### `musubi-tuner:wan:train`
**Code Name**: `musubi-tuner:wan:train`
**Description**: Train Wan LoRA model. Automatically checks for existing checkpoints and offers to resume if found.
**Tool**: `tools/ai/musubi-tuner`
**Script**: `tools/ai/musubi-tuner/scripts/wan-train.ps1`
**Quick Start Guide**: `tools/ai/musubi-tuner/TRAINING_QUICK_START.md` - Complete automated workflow for AI agents
**Parameters**: 
  - Task type (determine from model filename: `i2v-A14B` for I2V models, `t2v-A14B` for T2V models)
  - DiT path (check ComfyUI models directory or `.local/config.json`)
  - Dataset config (create from template in `tools/ai/musubi-tuner/datasets/`)
  - Output settings
  - Optional: Resume checkpoint path
**Key Workflow**:
  1. **Find models**: Check `E:\Stable Diffusion\ComfyUi Portable\ComfyUI\models\diffusion_models\` for `wan2.2_*` files
  2. **Check for checkpoints**: Look in output directory for `*epoch-*` directories
  3. **Determine task**: From model filename (`i2v` → `i2v-A14B`, `t2v` → `t2v-A14B`)
  4. **Determine mixed precision**: From model filename (`fp16` → `fp16`, `bf16` → `bf16`)
  5. **Train or resume**: Use `-Resume` parameter if checkpoints found
**Auto-Discovery**:
  - Models: Search ComfyUI directory or check config.json
  - Checkpoints: Scan output directory for `*epoch-*` patterns
  - Dataset config: Use template from `tools/ai/musubi-tuner/datasets/dataset-wan22.example.toml`
**Privacy**: Paths stored in local config

#### `musubi-tuner:wan:generate`
**Code Name**: `musubi-tuner:wan:generate`
**Description**: Generate video with Wan model
**Tool**: `tools/ai/musubi-tuner`
**Parameters**: Task, prompt, model paths, output settings
**Privacy**: Paths stored in local config

## Operation Discovery

Agents can query operations using:
- **Code names**: Short identifiers like `bambu-lab:launch`
- **Descriptions**: Natural language descriptions
- **Categories**: Group by category (system, ai)
- **Tools**: Operations grouped by tool

## Privacy Guidelines

- **Never commit**: API keys, personal paths, user-specific data
- **Always commit**: Operation code names, descriptions, tool structure
- **Local config**: User-specific paths stored in `.local/config.json` (gitignored)
- **Public registry**: `.toolset/operations.json` contains only public information

## Local Variables and Paths

**CRITICAL**: All local variables, paths, and user-specific data MUST remain local and NEVER be hardcoded in committed files.

- **Use placeholders**: Examples should use `C:/path/to/` or `E:/path/to/` format
- **Use config system**: Scripts should load paths from `.local/config.json` with fallback to defaults
- **No hardcoded user paths**: Never hardcode actual user paths like `E:\Stable Diffusion\Inputs\df\lib\celeb\angelina`
- **Template files**: Use `.example` suffix for templates (e.g., `config.example.json`)
- **Local-only files**: Dataset configs, personal scripts, and user data should be gitignored or stored in `.local/`

When creating scripts or config files:
1. Use parameter variables instead of hardcoded paths
2. Load from config with fallback to defaults
3. Use example/template files for documentation
4. Ensure user-specific paths are clearly marked as requiring local configuration

## Example Queries

**"What are my operations?"**
→ Returns all operations with code names and descriptions

**"What operations are available for Bambu Lab?"**
→ Returns `bambu-lab:*` operations

**"What AI operations do I have?"**
→ Returns all `musubi-tuner:*` operations

**"How do I launch Bambu Lab?"**
→ Returns `bambu-lab:launch` operation details

## Examples

### Example 1: Querying Operations - Good Pattern

**Scenario**: Agent needs to find available operations.

**Good:**
```powershell
# Query all operations
python .toolset/discover_operations.py

# Query by category
python .toolset/discover_operations.py --category system

# Query specific operation
python .toolset/discover_operations.py --code bambu-lab:launch

# Load operations.json programmatically
$operations = Get-Content .toolset/operations.json | ConvertFrom-Json
$systemOps = $operations.operations | Where-Object { $_.category -eq "system" }
```

**Bad:**
```powershell
# Hardcode operation codes
# Don't query registry
# Assume operations exist without checking
$operation = "bambu-lab:launch"  # Might not exist
```

### Example 2: Using Operations - Good Pattern

**Scenario**: Agent needs to execute an operation.

**Good:**
```powershell
# Step 1: Query operation details
$operation = python .toolset/discover_operations.py --code musubi-tuner:wan:train | ConvertFrom-Json

# Step 2: Check parameters
$requiredParams = $operation.parameters | Where-Object { $_.required -eq $true }

# Step 3: Execute with proper parameters
$toolPath = $operation.tool_path
$scriptPath = Join-Path $toolPath $operation.entry_point
powershell.exe -ExecutionPolicy Bypass -File $scriptPath -Param1 "value1" -Param2 "value2"
```

**Bad:**
```powershell
# Execute without checking operation exists
# Don't validate parameters
# Hardcode script paths
.\tools\ai\musubi-tuner\scripts\wan-train.ps1  # Path might be wrong
```

### Example 3: Handling Local Variables - Good Pattern

**Scenario**: Operation needs user-specific paths.

**Good:**
```powershell
# Load from local config
$configPath = ".local/config.json"
if (Test-Path $configPath) {
    $config = Get-Content $configPath | ConvertFrom-Json
    $modelPath = $config.modelPath
} else {
    # Use placeholder in documentation
    Write-Error "ERROR_TYPE: ConfigNotFound"
    Write-Error "ERROR_SUGGESTION: Set modelPath in .local/config.json"
    exit 1
}

# Use config value
$operation = "musubi-tuner:wan:train"
# Pass $modelPath as parameter
```

**Bad:**
```powershell
# Hardcode user path
$modelPath = "E:\Users\John\Models\..."  # NEVER DO THIS
# Commit user-specific paths
# Don't use config system
```

